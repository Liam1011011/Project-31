#include <Adafruit_GFX.h>    // Core graphics library
#include <Adafruit_ST7789.h> // Hardware-specific library for ST7789
#include <SPI.h>

  #define TFT_CS        10
  #define TFT_RST        9 // Or set to -1 and connect to Arduino RESET pin
  #define TFT_DC         8

  Adafruit_ST7789 tft = Adafruit_ST7789(TFT_CS, TFT_DC, TFT_RST);

int tcurrent = 0;
int tempArray[120];
char currentString[3];

float p = 3.1415926;

void getTemp() // function to read temperature from TMP36
{
  float sum = 0;
  float voltage = 0;
  float sensor = 0;
  float celsius;

  // read the temperature sensor and convert the result to degrees C
  sensor   = analogRead(5);
  voltage  = (sensor * 5000) / 1024;
  voltage  = voltage - 500;
  celsius  = voltage / 10;
  tcurrent = int(celsius);

  // insert the new temperature at the start of the array of past temperatures
  for (int a = 119 ; a >= 0 ; --a )
  {
    tempArray[a] = tempArray[a - 1];
  }
  tempArray[0] = tcurrent;
}

void drawScreen() // generate TFT LCD display effects
{
  int q;
  // display current temperature
  tft.fillScreen(ST77XX_BLACK);   // clear screen to black
  tft.setTextColor(ST77XX_ORANGE); // white text
  tft.setTextSize(2);
  tft.setCursor(20, 0);
  tft.println("Current:");
  String tempString = String(tcurrent);
  tempString.toCharArray(currentString, 3);
  tft.setCursor(115, 0);
  tft.println(currentString);
  // draw scale for graph
  tft.setTextSize(1);
  tft.setCursor(0, 20);
  tft.println("50");
  tft.setCursor(0, 30);
  tft.println("45");
  tft.setCursor(0, 40);
  tft.println("40");
  tft.setCursor(0, 50);
  tft.println("35");
  tft.setCursor(0, 60);
  tft.println("30");
  tft.setCursor(0, 70);
  tft.println("25");
  tft.setCursor(0, 80);
  tft.println("20");
  tft.setCursor(0, 90);
  tft.println("15");
  tft.setCursor(0, 100);
  tft.println("10");
  tft.setCursor(0, 110);
  tft.println(" 5");
  tft.setCursor(0, 120);
  tft.println(" 0");
  tft.drawLine(20, 20, 20, 127, ST77XX_ORANGE); 
  // plot temperature data points
  for (int a = 25 ; a < 145 ; a++)
  {
    // convert the temperature value to a suitable y-axis position on the LCD
    q = (123 - (tempArray[a - 25] * 2));
  tft.drawPixel(a, q, ST77XX_ORANGE);
  }
}

void setup()
{
  tft.init(240, 320); 
  tft.fillScreen(ST77XX_BLACK);
}

void loop()
{
  getTemp();
  drawScreen();
  for (int a = 0 ; a < 20 ; a++) // wait 20 minutes until the next reading
  {
    delay(60000);                // wait 1 minute
  }
}
